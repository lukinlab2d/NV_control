"""
This file is part of B00 codes based on b26_toolkit. Questions are addressed to Hoang Le.
"""

import pyvisa as visa
import sys
import time
from qcodes.instrument.base import Instrument
from qcodes.instrument.parameter import Parameter
from pyvisa.constants import Parity, StopBits, ControlFlow

class Lakeshore335():
    def __init__(self, name="Lakeshore335", settings=None, **kwargs) -> None:
        rm = visa.ResourceManager()
        self.rm = rm
        self.ls = rm.open_resource("COM" + str(9))
        self.ls.baud_rate = 57600
        self.ls.data_bits = 7
        self.ls.stop_bits = StopBits.one
        self.ls.parity = Parity.odd
        # self.ls.flow_control = ControlFlow.none
        self.ls.write_termination = "\n"
        self.ls.read_termination = "\n"

        self.ls.write(r"*IDN?")
        s = self.ls.read()
        print(f"{s}")

        command = "SETP? 1"
        self.ls.write(command)
        s = self.ls.read()
        print(f"Current setpoint = {s}")

    def set_setp(self, setp):
        command = "SETP 1," + str(setp)
        print(f"Write command {command}")
        self.ls.write(command)
        time.sleep(1)
        
        
    def set_PID(self,p=0,i=0,d=0):
        command = "PID 1," + str(p) + "," + str(i) + "," + str(d)
        print(f"Write command {command}")
        self.ls.write(command)
        time.sleep(1)
        
    def set_heaterRange(self, range):
        command = "RANGE 1," + str(range)
        print(f"Write command {command}")
        self.ls.write(command)
        time.sleep(1)
        
    def allOff(self):
        self.ls.write("RANGE 1," + str(0))
        self.ls.write("RANGE 2," + str(0))
        print(f"ALL OFF")
        time.sleep(1)
    
    def close(self):
        self.ls.close()
        self.rm.close()
        time.sleep(1)
   
if __name__ == "__main__":
    ls = Lakeshore335()
    ls.set_setp(11.15)
    ls.set_PID(p=90,i=90,d=0)
    ls.set_heaterRange(range=2)
    # ls.allOff()
    ls.close()

    # ls = Lakeshore335()
    # for i in range(11):
    #     ls.set_setp(270-27*i)
    #     ls.set_PID(p=1,i=1,d=0)
    #     if i <= 6:
    #         ls.set_heaterRange(range=3)
    #     else:
    #         ls.set_heaterRange(range=2)
    #     if i==9:
    #         ls.allOff()
    #         ls.close()
    #     time.sleep(120)
    # ls.close()